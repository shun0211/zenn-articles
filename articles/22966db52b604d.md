---
title: "LangGraphã§å­¦ã¶Agentic RAGè§£èª¬"
emoji: ğŸ¡
type: tech
topics: ["LangGraph", "LangChain", "RAG", "LLM"]
published: true
---

ã“ã‚“ã«ã¡ã¯ã€é…’äº•ã§ã™ï¼
[æ ªå¼ä¼šç¤¾ EGGHEAD](https://egghead.co.jp)ï¼ˆã‚¨ãƒƒã‚°ãƒ˜ãƒƒãƒ‰ï¼‰ã¨ã„ã†ã€Œè£½é€ æ¥­ã§ç”Ÿæˆ AI ã‚’æ´»ç”¨ã—ãŸã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã€ã‚’ã—ã¦ã„ã‚‹ä¼šç¤¾ã®ä»£è¡¨ã‚’ã—ã¦ãŠã‚Šã¾ã™ã€‚

https://egghead.co.jp

ä»Šå›ã¯ LangGraph ã® Agentic RAG ã«ã¤ã„ã¦ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’ã‚‚ã¨ã« Agentic RAG ã¨ã¯ï¼Ÿã‚„ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã®è£œè¶³è§£èª¬ã‚’ã—ã¾ã—ãŸã€‚

æœ¬è¨˜äº‹ã‚’èª­ã‚€ã“ã¨ã§ã€ä»¥ä¸‹ã®ãƒã‚¤ãƒ³ãƒˆãŒç†è§£ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚

ğŸ‘‰ **å¾“æ¥ã®RAGã®é™ç•Œã¨ã€Agentic RAGã®ãƒ¡ãƒªãƒƒãƒˆ**ãŒåˆ†ã‹ã‚‹  
ğŸ‘‰ **LangGraphã‚’ä½¿ã£ãŸAgentic RAGã®åŸºæœ¬çš„ãªå®Ÿè£…æ–¹æ³•**ãŒå­¦ã¹ã‚‹  

æœ¬è¨˜äº‹ãŒã€LangGraph ã‚’æ´»ç”¨ã—ãŸ AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–‹ç™ºã®åˆå­¦è€…ã®æ–¹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚

https://langchain-ai.github.io/langgraph/tutorials/rag/langgraph_agentic_rag/

## 1. ã¯ã˜ã‚ã«

### å¾“æ¥ã® RAG ã¨ãã®å•é¡Œç‚¹

æ¤œç´¢æ‹¡å¼µç”Ÿæˆï¼ˆRetrieval-Augmented Generationã€RAGï¼‰ã¯ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ã‚¨ãƒ³ã¹ãƒ‡ã‚£ãƒ³ã‚°ã‚’è¡Œã£ã¦ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ã—ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¯ã‚¨ãƒªã‹ã‚‰è¿‘ã—ã„æ–‡è„ˆã‚’å–ã‚Šå‡ºã—ã€LLM ã«é–¢é€£ã™ã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦æä¾›ã—å¤–éƒ¨çŸ¥è­˜ã«åŸºã¥ã„ãŸå›ç­”ã‚’è¡Œã†ã¨ã„ã†æŠ€è¡“ã§ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/15c227befb56-20250225.png)

ã—ã‹ã—ã€å¾“æ¥ã® RAG ã«ã¯ä»¥ä¸‹ã® 2 ã¤ã®å¤§ããªåˆ¶ç´„ãŒã‚ã‚Šã¾ã™ã€‚

#### å•é¡Œç‚¹ 1ï¼šå˜ä¸€ã®çŸ¥è­˜ã‚½ãƒ¼ã‚¹ã«é™å®šã•ã‚Œã‚‹

åŸºæœ¬çš„ãª RAG ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¯ä¸€ã¤ã®å¤–éƒ¨çŸ¥è­˜ã®ã‚½ãƒ¼ã‚¹ã®ã¿ã‚’ä½¿ã£ã¦æ¤œç´¢ã‚’è¡Œã†ã“ã¨ã§ã™ã€‚å¤šãã®å ´åˆã€è¤‡æ•°ã®å¤–éƒ¨çŸ¥è­˜ãŒãªã„ã¨ç­”ãˆã‚‰ã‚Œãªã„ã‚±ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã™ã€‚

:::message
**å®Ÿä¾‹**ï¼šã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã®é‹ç”¨ä¿å®ˆã‚’ã‚„ã£ã¦ã„ãŸã“ã‚ã€ã€ŒæŒ™å‹•ãŒãŠã‹ã—ã„ã‹ã‚‰ä»•æ§˜ã‚’æ•™ãˆã¦æ¬²ã—ã„ã€ã¨ CS ã‹ã‚‰é ¼ã¾ã‚Œã‚‹ã“ã¨ãŒã‚ˆãã‚ã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã¯ãŠå®¢æ§˜ã®ç’°å¢ƒã§ã®ãƒã‚°ã®çŠ¶æ…‹ã€éå»ã®å•ã„åˆã‚ã›ãƒ­ã‚°ã€ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãã‚Œãã‚Œè¦‹ã¦ç·åˆçš„ã«åˆ¤æ–­ã™ã‚‹ã®ãŒå¿…è¦ã§ã™ã€‚å½“ç„¶ãªãŒã‚‰ã“ã†ã„ã£ãŸã“ã¨ã¯å¾“æ¥ã® RAG ã§ã¯ä¸å¯èƒ½ã§ã™ã€‚
:::

#### å•é¡Œç‚¹ 2ï¼šæ¤œè¨¼ãªã—ã®ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆæ¤œç´¢

åŸºæœ¬çš„ã«æ¤œç´¢ã¯ãƒ¯ãƒ³ã‚·ãƒ§ãƒƒãƒˆã§è¡Œã†ãŸã‚ã€æ­£ã—ã„æ–‡è„ˆãŒæ¤œç´¢ã§ãã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚‹ã“ã¨ã§ã™ã€‚å¾“æ¥ã® RAG ã§ã¯å–å¾—ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒæ­£ã—ã„ã‹ã®æ¤œè¨¼ã¯è¡Œã„ã¾ã›ã‚“ã€‚

ã“ã‚Œã‚‰ã‚’è§£æ±ºã™ã‚‹ã®ãŒ Agentic RAG ã¨å‘¼ã°ã‚Œã‚‹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ¼ã§ã™ã€‚

## 2. Agentic RAG ã¨ã¯

Agentic RAG ã¨ã¯ã€AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã® RAG å®Ÿè£…ã‚’æŒ‡ã—ã¾ã™ã€‚å¾“æ¥ã® RAG ã®å•é¡Œç‚¹ã‚’è§£æ±ºã™ã‚‹ãŸã‚ã«ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯çŠ¶æ…‹ã‚’æŒã¡ã€è‡ªå¾‹çš„ã«åˆ¤æ–­ã‚’ã—ã¦è¡Œå‹•ã—ã¾ã™ã€‚å…·ä½“çš„ã«ã¯ã€ã€Œæ¤œç´¢ã™ã‚‹ã‹ã©ã†ã‹ã€ã€Œå–å¾—ã—ãŸæ–‡æ›¸ã¯é–¢é€£æ€§ãŒã‚ã‚‹ã‹ã€ã€Œã‚¯ã‚¨ãƒªã‚’æ›¸ãæ›ãˆã‚‹ã¹ãã‹ã€ã¨ã„ã£ãŸåˆ¤æ–­ã‚’è‡ªå¾‹çš„ã«è¡Œã„ã€è¤‡æ•°ã®çŸ¥è­˜ã‚½ãƒ¼ã‚¹ã‚’æ´»ç”¨ã—ãŸã‚Šã€æ¤œç´¢çµæœã®æ¤œè¨¼ã‚’è¡Œã£ãŸã‚Šã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šç²¾åº¦ã®é«˜ã„å›ç­”ã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

![](https://storage.googleapis.com/zenn-user-upload/e73d54e959c1-20250225.png)

å›³ãŒç¤ºã™ã‚ˆã†ã«ã€Agentic RAGã®æœ€å¤§ã®ç‰¹å¾´ã¯ã€Œè€ƒãˆã¦è¡Œå‹•ã™ã‚‹ã€èƒ½åŠ›ã§ã™ã€‚å¾“æ¥ã®RAGãŒå˜ç´”ã«ã€Œæ¤œç´¢ã—ã¦å›ç­”ã™ã‚‹ã€ã ã‘ãªã®ã«å¯¾ã—ã€Agentic RAGã¯ä»¥ä¸‹ã®ã‚ˆã†ãªåˆ¤æ–­ã¨è¡Œå‹•(ReAct)ã‚’è‡ªå¾‹çš„ã«è¡Œã„ã¾ã™ã€‚

1. **è³ªå•åˆ†æ**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’æ·±ãç†è§£ã—ã€æœ¬å½“ã«çŸ¥ã‚ŠãŸã„ã“ã¨ã¯ä½•ã‹ã‚’æŠŠæ¡ã—ã¾ã™
2. **æ¤œç´¢åˆ¤æ–­**: å¤–éƒ¨æƒ…å ±ãŒå¿…è¦ã‹ã©ã†ã‹ã‚’è‡ªåˆ†ã§åˆ¤æ–­ã—ã¾ã™ï¼ˆæ—¢çŸ¥ã®æƒ…å ±ãªã‚‰æ¤œç´¢ã›ãšã«å›ç­”ï¼‰
3. **æƒ…å ±æºé¸æŠ**: è³ªå•ã«å¿œã˜ã¦æœ€é©ãªæƒ…å ±æºï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã€APIã€ã‚¦ã‚§ãƒ–ãªã©ï¼‰ã‚’é¸ã³ã¾ã™
4. **çµæœè©•ä¾¡**: æ¤œç´¢çµæœãŒè³ªå•ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã€ååˆ†ã‹ã‚’è©•ä¾¡ã—ã¾ã™
5. **ã‚¯ã‚¨ãƒªæ”¹å–„**: æ¤œç´¢çµæœãŒä¸ååˆ†ãªã‚‰ã€ã‚ˆã‚Šè‰¯ã„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§å†æ¤œç´¢ã—ã¾ã™
6. **ãƒ¦ãƒ¼ã‚¶ãƒ¼é€£æº**: å¿…è¦ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿½åŠ æƒ…å ±ã‚’æ±‚ã‚ãŸã‚Šç¢ºèªã—ãŸã‚Šã—ã¾ã™

ã¾ãŸã€Agentic RAG ã¨å¾“æ¥ã® RAG ã¨æ¯”è¼ƒã—ãŸå›³ãŒã“ã¡ã‚‰ã«ãªã‚Šã¾ã™ã€‚

| æ©Ÿèƒ½                     | å¾“æ¥ã® RAG | Agentic RAG |
| ------------------------ | :--------: | :---------: |
| å¤–éƒ¨ãƒ„ãƒ¼ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹   |   ã„ã„ãˆ   |    ã¯ã„     |
| å¿…è¦ã«å¿œã˜ãŸã‚¯ã‚¨ãƒªå‰å‡¦ç† |   ã„ã„ãˆ   |    ã¯ã„     |
| è¤‡æ•°ã‚¹ãƒ†ãƒƒãƒ—ã®æ¤œç´¢       |   ã„ã„ãˆ   |    ã¯ã„     |
| å–å¾—ã—ãŸæƒ…å ±ã®æ¤œè¨¼       |   ã„ã„ãˆ   |    ã¯ã„     |

ä¸Šè¨˜ã®ä¾‹ã‚„æ¯”è¼ƒè¡¨ãŒç¤ºã™ã‚ˆã†ã«ã€Agentic RAG ã¯å¾“æ¥ã® RAG ã®é™ç•Œã‚’è¶…ãˆã€è¤‡æ•°ã®æƒ…å ±æºã®æ´»ç”¨ã‚„æ¤œç´¢çµæœã®æ¤œè¨¼ãªã©ã€ã‚ˆã‚Šé«˜åº¦ãªæ©Ÿèƒ½ã‚’å‚™ãˆã¦ã„ã¾ã™ã€‚ã“ã‚Œã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«å¯¾ã—ã¦ã‚ˆã‚Šæ­£ç¢ºã§é–¢é€£æ€§ã®é«˜ã„å›ç­”ã‚’æä¾›ã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

Agentic RAGã«ã¤ã„ã¦ã®è©³ç´°ã¯Weaviateã®ã“ã¡ã‚‰ã®è¨˜äº‹ãŒåˆ†ã‹ã‚Šã‚„ã™ã‹ã£ãŸã®ã§ãŠã™ã™ã‚ã§ã™ï¼

https://weaviate.io/blog/what-is-agentic-rag

## 3. AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè£…ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

ã¾ãšã¯ã€ã‚¿ã‚¹ã‚¯ã‚’è‡ªå‹•çš„ã«è¡Œã†ãŸã‚ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æ•´ç†ã—ãŸã„ã¨æ€ã„ã¾ã™ã€‚ä¸»ã«äºŒç¨®é¡ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«åˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚

### ã‚·ãƒ¼ã‚±ãƒ³ã‚·ãƒ£ãƒ«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

æœ€ã‚‚å˜ç´”ãªæ–¹æ³•ã§ã€ä¸€é€£ã®å‡¦ç†ã‚’é †ç•ªã«å®Ÿè¡Œã—ã¾ã™ã€‚Dify ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒè¿‘ã„ã§ã™ã€‚

![](/images/agentic-rag/image-4.png)

### ã‚°ãƒ©ãƒ•æ§‹é€ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ

ã‚°ãƒ©ãƒ•æ§‹é€ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã¯ã€å„å‡¦ç†ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã€Œãƒãƒ¼ãƒ‰ã€ã¨ã—ã¦å®šç¾©ã—ã€ãã‚Œã‚‰ã®é–“ã®é–¢ä¿‚æ€§ã‚„é·ç§»ã‚’ã€Œã‚¨ãƒƒã‚¸ã€ã¨ã—ã¦æ¥ç¶šã™ã‚‹ã“ã¨ã§ã‚°ãƒ©ãƒ•ã‚’æ§‹ç¯‰ã—ã¾ã™ã€‚ã“ã®ã‚°ãƒ©ãƒ•æ§‹é€ ã«ã‚ˆã£ã¦ã€å‡¦ç†ã®æµã‚Œã‚’æŸ”è»Ÿã«åˆ¶å¾¡ã§ãã€æ¡ä»¶ã«å¿œã˜ã¦ç•°ãªã‚‹çµŒè·¯ã‚’é¸æŠã™ã‚‹ã“ã¨ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚ä¾‹ãˆã°ã€æ¤œç´¢çµæœãŒä¸ååˆ†ãªå ´åˆã¯å†æ¤œç´¢ãƒãƒ¼ãƒ‰ã«é€²ã‚€ãªã©ã€çŠ¶æ³ã«å¿œã˜ãŸåˆ¤æ–­ãŒã§ãã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã§ãã¾ã™ã€‚

AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¨ã¯ã€Œã‚´ãƒ¼ãƒ«ã«å¯¾ã—ã¦è‡ªå¾‹çš„ã«ã‚¿ã‚¹ã‚¯ã‚’é‚è¡Œã§ãã‚‹ AI ã‚·ã‚¹ãƒ†ãƒ ã€ã§ã™ã€‚ã“ã® AI ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’å®Ÿè£…ã™ã‚‹åŠ¹æœçš„ãªæ–¹æ³•ãŒã‚°ãƒ©ãƒ•æ§‹é€ ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã€LangGraph ã¯ã“ã®ã‚°ãƒ©ãƒ•æ§‹é€ ã‚’ç°¡å˜ã«å®Ÿè£…ã§ãã‚‹ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã§ã™ã€‚

### ã‚°ãƒ©ãƒ•æ§‹é€ ã«ã¤ã„ã¦

ã‚°ãƒ©ãƒ•æ§‹é€ ã¯ã€ä»¥ä¸‹ã® 3 ã¤ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

1. **ãƒãƒ¼ãƒ‰**: å„å‡¦ç†ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ¤æ–­ã€æ¤œç´¢ã€ã‚¯ã‚¨ãƒªæ›¸ãæ›ãˆã€å›ç­”ç”Ÿæˆãªã©ï¼‰ã‚’å®Ÿè¡Œã™ã‚‹å ´æ‰€
2. **ã‚¨ãƒƒã‚¸**: ãƒãƒ¼ãƒ‰é–“ã®æ¥ç¶šç·šã§ã€å‡¦ç†ã®æµã‚Œã‚’å®šç¾©
3. **æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸**: çŠ¶æ…‹ã«å¿œã˜ã¦æ¬¡ã«é€²ã‚€ãƒãƒ¼ãƒ‰ã‚’å‹•çš„ã«æ±ºå®šã™ã‚‹ç‰¹æ®Šãªã‚¨ãƒƒã‚¸

ã“ã‚Œã‚‰ã®è¦ç´ ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€æŸ”è»Ÿã§çŠ¶æ³ã«å¿œã˜ãŸå‡¦ç†ã®æµã‚Œã‚’å®Ÿç¾ã§ãã¾ã™ã€‚

![](/images/agentic-rag/image-3.png)

## Agentic RAG ã®å®Ÿè£…è©³ç´°

ã“ã“ã‹ã‚‰ã¯ LangGraph ã®ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã®ä¾‹ã‚’ã‚‚ã¨ã« LangGraph ã‚’ä½¿ã£ãŸ Agentic RAG ã®å®Ÿè£…ã®è©³ç´°ã‚’è¦‹ã¦ã„ãã¾ã™ã€‚
ä¸»è¦ãªãƒãƒ¼ãƒ‰ã¯ä»¥ä¸‹ã¨ãªã£ã¦ã„ã¾ã™ã€‚

1. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰**: LLM ã‚’ä½¿ç”¨ã—ã¦æ–‡æ›¸å–å¾—ã®åˆ¤æ–­ã‚’è¡Œã†
2. **æ–‡æ›¸å–å¾—ãƒãƒ¼ãƒ‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«é–¢é€£ã™ã‚‹æ–‡æ›¸ã‚’å–å¾—ã™ã‚‹
3. **ã‚¯ã‚¨ãƒªå†æ§‹ç¯‰ãƒãƒ¼ãƒ‰**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’æ”¹å–„ã™ã‚‹
4. **å›ç­”ç”Ÿæˆãƒãƒ¼ãƒ‰**: å–å¾—ã—ãŸæ–‡æ›¸ã‚’ä½¿ç”¨ã—ã¦å›ç­”ã‚’ç”Ÿæˆã™ã‚‹

ã“ã‚Œã‚‰ã®ãƒãƒ¼ãƒ‰ã§ä»¥ä¸‹ã®ã‚ˆã†ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚ã“ã“ã§ã¯ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’ LangGraph ã‚’ä½¿ã£ã¦å®Ÿè£…ã—ã¦ã„ãã¾ã™ã€‚

![](/images/agentic-rag/image-1.png)

### çŠ¶æ…‹ç®¡ç†

LangGraph ã§ã¯ã€å„ãƒãƒ¼ãƒ‰ã§çŠ¶æ…‹ï¼ˆStateï¼‰ã‚’å…±æœ‰ã—ã¾ã™ã€‚å„ãƒãƒ¼ãƒ‰ã¯ç‹¬ç«‹ã—ã¦ã„ã¾ã™ãŒã€ã“ã®çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ï¼‰ã™ã‚‹ã“ã¨ã§æƒ…å ±ã‚’ä¼é”ã—ã¾ã™ã€‚
ãŸã¨ãˆã°ã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰ã¯ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ ã—ã€æ–‡æ›¸å–å¾—ãƒãƒ¼ãƒ‰ã¯å–å¾—ã—ãŸæ–‡æ›¸ã®å†…å®¹ã‚’ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦è¿½åŠ ã—ã¾ã™ã€‚

```python
class AgentState(TypedDict):
    # add_messagesé–¢æ•°ã¯æ›´æ–°æ–¹æ³•ã‚’å®šç¾©ã—ã¾ã™
    # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ç½®æ›ã§ã™ãŒã€add_messagesã¯ã€Œè¿½åŠ ã€ã‚’æ„å‘³ã—ã¾ã™
    messages: Annotated[Sequence[BaseMessage], add_messages]
```

### ã‚°ãƒ©ãƒ•æ§‹é€ ã®æ§‹ç¯‰

ãƒ¡ã‚¤ãƒ³ã§ã‚ã‚‹ã‚°ãƒ©ãƒ•æ§‹é€ ã®æ§‹ç¯‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«è¡Œã„ã¾ã™ã€‚`StateGraph`ã®å¼•æ•°ã«å…ˆã»ã©ã®`AgentState`ã‚’æŒ‡å®šã—ã¦åˆæœŸåŒ–ã—ã€ãã“ã«`add_node`ã€`add_edge`ã€`add_conditional_edges`ã‚’ä½¿ã£ã¦ã‚°ãƒ©ãƒ•æ§‹é€ ã‚’ä½œæˆã—ã¦ã„ãã¾ã™ã€‚
`add_node`ã¨`add_edge`ã®ç¬¬äºŒå¼•æ•°ã«ã¯ãã‚Œãã‚Œé–¢æ•°ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¦ã€ã“ã‚ŒãŒå‘¼ã³å‡ºã•ã‚Œã¾ã™ã€‚

```python
workflow = StateGraph(AgentState)
workflow.add_node("agent", agent)
retrieve = ToolNode([retriever_tool])
workflow.add_node("retrieve", retrieve)
workflow.add_node("rewrite", rewrite)
workflow.add_node("generate", generate)

workflow.add_edge(START, "agent")
workflow.add_conditional_edges("agent", tools_condition, {"tools": "retrieve", END: END})
workflow.add_conditional_edges("retrieve", grade_documents)
workflow.add_edge("generate", END)
workflow.add_edge("rewrite", "agent")

graph = workflow.compile()
```

![](/images/agentic-rag/image-2.png =50%x)

ã“ã®ã‚³ãƒ¼ãƒ‰ã¯ã€èµ·ç‚¹ã¨ãªã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‹ã‚‰å§‹ã¾ã‚Šã€æ¡ä»¶ã«å¿œã˜ã¦æ¤œç´¢ã€è©•ä¾¡ã€æ›¸ãæ›ãˆã€ç”Ÿæˆã¨ã„ã£ãŸä¸€é€£ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’ã‚°ãƒ©ãƒ•ã¨ã—ã¦å®šç¾©ã—ã¦ã„ã¾ã™ã€‚`compile()`ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿè¡Œå¯èƒ½ãªã‚°ãƒ©ãƒ•ãŒç”Ÿæˆã•ã‚Œã€`stream()`ãƒ¡ã‚½ãƒƒãƒ‰ã§å®Ÿéš›ã«å‡¦ç†ã‚’è¡Œã„ã¾ã™ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰ã«ã‚ˆã‚‹ã‚¯ã‚¨ãƒªåˆ†æã¨æ¤œç´¢åˆ¤æ–­

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ãŒå…¥åŠ›ã•ã‚Œã‚‹ã¨ã€ã¾ãšã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰ï¼ˆ`agent`é–¢æ•°ï¼‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’åˆ†æã—ã€æ¤œç´¢ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã—ã¾ã™ã€‚
2. ã“ã®åˆ¤æ–­ã¯ã€è³ªå•ã®æ€§è³ªï¼ˆäº‹å®Ÿé–¢é€£ã®è³ªå•ã‹æ„è¦‹ã‚’æ±‚ã‚ã‚‹è³ªå•ã‹ãªã©ï¼‰ã‚„ã€ãƒ¢ãƒ‡ãƒ«ãŒæ—¢ã«çŸ¥è­˜ã‚’æŒã£ã¦ã„ã‚‹ã‹ã©ã†ã‹ã«åŸºã¥ã„ã¦è¡Œã‚ã‚Œã¾ã™ã€‚
3. æ¤œç´¢ãŒå¿…è¦ã¨åˆ¤æ–­ã—ãŸå ´åˆã€ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯ãƒ„ãƒ¼ãƒ«å‘¼ã³å‡ºã—ï¼ˆ`tool_calls`ï¼‰ã‚’ç”Ÿæˆã—ã€çŠ¶æ…‹ã«è¿½åŠ ã—ã¾ã™ã€‚

```python
def agent(state):
    messages = state["messages"]
    model = ChatOpenAI(temperature=0, streaming=True, model="gpt-4o")
    model = model.bind_tools(tools)
    response = model.invoke(messages)
    return {"messages": [response]}
```

### æ–‡æ›¸ã®é–¢é€£æ€§è©•ä¾¡ã¨æ¡ä»¶ä»˜ãã‚¨ãƒƒã‚¸ã®å®Ÿè£…

æ¤œç´¢ãƒ„ãƒ¼ãƒ«ãŒå‘¼ã³å‡ºã•ã‚Œã‚‹ã¨ã€æ–‡æ›¸å–å¾—ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã€ãƒ™ã‚¯ãƒˆãƒ« DB ã‹ã‚‰é–¢é€£æ–‡æ›¸ã‚’å–å¾—ã—ã¾ã™ã€‚

1. æ–‡æ›¸å–å¾—ãƒãƒ¼ãƒ‰ã¯ãƒªãƒˆãƒªãƒ¼ãƒãƒ¼ãƒ„ãƒ¼ãƒ«ã‚’ä½¿ã„ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã‚’ä½¿ç”¨ã—ã¦ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ãƒˆã‚¢ã«å•ã„åˆã‚ã›ã¾ã™ã€‚
2. å–å¾—ã•ã‚ŒãŸæ–‡æ›¸ã¯ã€ãƒ„ãƒ¼ãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦çŠ¶æ…‹ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
3. æ¬¡ã«ã€`grade_documents`é–¢æ•°ãŒæ–‡æ›¸ã®é–¢é€£æ€§ã‚’è©•ä¾¡ã—ã¾ã™ã€‚

```python
def grade_documents(state) -> Literal["generate", "rewrite"]:
    model = ChatOpenAI(temperature=0, model="gpt-4o", streaming=True)
    llm_with_tool = model.with_structured_output(grade)

    messages = state["messages"]
    question = messages[0].content
    docs = last_message.content

    scored_result = chain.invoke({"question": question, "context": docs})
    score = scored_result.binary_score

    if score == "yes":
        return "generate"
    else:
        return "rewrite"
```

ã“ã®é–¢æ•°ã¯å–å¾—ã•ã‚ŒãŸæ–‡æ›¸ãŒãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«é–¢é€£ã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’ LLM ã«åˆ¤æ–­ã•ã›ã¦ã„ã¾ã™ã€‚é–¢é€£æ€§ãŒã‚ã‚Œã°ã€Œgenerateã€ãƒãƒ¼ãƒ‰ã¸ã€ãªã‘ã‚Œã°ã€Œrewriteã€ãƒãƒ¼ãƒ‰ã¸ã¨å‡¦ç†ãŒé€²ã¿ã¾ã™ã€‚

### ã‚¯ã‚¨ãƒªå†æ§‹ç¯‰ãƒãƒ¼ãƒ‰ã«ã‚ˆã‚‹æ¤œç´¢ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

æ–‡æ›¸ã®é–¢é€£æ€§ãŒä½ã„ã¨åˆ¤æ–­ã•ã‚ŒãŸå ´åˆã€ã‚¯ã‚¨ãƒªå†æ§‹ç¯‰ãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã™ã€‚

1. `rewrite`é–¢æ•°ã¯ã€å…ƒã®è³ªå•ã®æ„å‘³ã‚’è§£æã—ã€ã‚ˆã‚ŠåŠ¹æœçš„ãªæ¤œç´¢ã‚¯ã‚¨ãƒªã«ãªã‚‹ã‚ˆã†æ›¸ãæ›ãˆã¾ã™ã€‚
2. æ›¸ãæ›ãˆã‚‰ã‚ŒãŸã‚¯ã‚¨ãƒªã¯ã€æ–°ã—ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦çŠ¶æ…‹ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚
3. å‡¦ç†ã¯å†ã³ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãƒãƒ¼ãƒ‰ã«æˆ»ã‚Šã€æ–°ã—ã„ã‚¯ã‚¨ãƒªã§æ¤œç´¢ã‚’è©¦ã¿ã¾ã™ã€‚

```python
def rewrite(state):
    messages = state["messages"]
    question = messages[0].content

    msg = [
        HumanMessage(
            content=f""" \n
    å…¥åŠ›ã‚’è¦‹ã¦ã€åŸºæœ¬çš„ãªæ„å‘³çš„æ„å›³/æ„å‘³ã«ã¤ã„ã¦è€ƒãˆã¦ã¿ã¦ãã ã•ã„ã€‚ \n
    ã“ã‚ŒãŒæœ€åˆã®è³ªå•ã§ã™:
    \n ------- \n
    {question}
    \n ------- \n
    æ”¹å–„ã•ã‚ŒãŸè³ªå•ã‚’ä½œæˆã—ã¦ãã ã•ã„: """,
        )
    ]

    model = ChatOpenAI(temperature=0, model="gpt-4o", streaming=True)
    response = model.invoke(msg)
    return {"messages": [response]}
```

ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã‚ˆã‚Šã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ãŒä¸æ˜ç­ã ã£ãŸã¨ã—ã¦ã‚‚ã€ã‚·ã‚¹ãƒ†ãƒ ã¯è‡ªå¾‹çš„ã«æ”¹å–„ã—ã¦é©åˆ‡ãªæ–‡æ›¸ã‚’æ¤œç´¢ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

### å›ç­”ç”Ÿæˆãƒãƒ¼ãƒ‰ã«ã‚ˆã‚‹æœ€çµ‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ä½œæˆ

é–¢é€£æ€§ã®é«˜ã„æ–‡æ›¸ãŒå–å¾—ã§ããŸå ´åˆã€ç”Ÿæˆãƒãƒ¼ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¦æœ€çµ‚çš„ãªå›ç­”ã‚’ä½œæˆã—ã¾ã™ã€‚

1. `generate`é–¢æ•°ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã¨å–å¾—ã•ã‚ŒãŸæ–‡æ›¸ã‚’çµ„ã¿åˆã‚ã›ã¦ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
2. ã“ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯ LLM ã«é€ã‚‰ã‚Œã€å›ç­”ãŒç”Ÿæˆã•ã‚Œã¾ã™ã€‚
3. ç”Ÿæˆã•ã‚ŒãŸå›ç­”ã¯ã€æœ€çµ‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¨ã—ã¦çŠ¶æ…‹ã«è¿½åŠ ã•ã‚Œã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¿”ã•ã‚Œã¾ã™ã€‚

```python
def generate(state):
    messages = state["messages"]
    question = messages[0].content
    last_message = messages[-1]
    docs = last_message.content

    prompt = hub.pull("rlm/rag-prompt")
    llm = ChatOpenAI(model_name="gpt-4o-mini", temperature=0, streaming=True)
    rag_chain = prompt | llm | StrOutputParser()

    response = rag_chain.invoke({"context": docs, "question": question})
    return {"messages": [response]}
```

ã“ã®å›ç­”ç”Ÿæˆãƒ—ãƒ­ã‚»ã‚¹ã§ã¯ã€RAG å°‚ç”¨ã«è¨­è¨ˆã•ã‚ŒãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä½¿ç”¨ã—ã¦ã€å–å¾—ã—ãŸæ–‡æ›¸ã®æƒ…å ±ã‚’æ­£ç¢ºã«åæ˜ ã—ãŸå›ç­”ã‚’ä½œæˆã—ã¾ã™ã€‚

:::message
rlm/rag-prompt ã¯ LangChain ãŒç”¨æ„ã—ã¦ã„ã‚‹ RAG ã®ãŸã‚ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã§ã™ã€‚
https://smith.langchain.com/hub/rlm/rag-prompt
:::

å®Ÿè¡ŒçµæœãŒä»¥ä¸‹ã«ãªã‚Šã¾ã™ã€‚å›ç­”ãŒè‹±èªã§è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã¯`rlm/rag-prompt`ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè‹±èªãªãŸã‚ãªã®ã§ã€æ—¥æœ¬èªã«ã—ãŸã„å ´åˆã¯ã€ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è‡ªåˆ†ã§æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

```
---ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå‘¼ã³å‡ºã—---
"Output from node 'agent':"
'---'
{ 'messages': [ AIMessage(content='', additional_kwargs={'tool_calls': [{'index': 0, 'id': 'call_hoAPuod1TD9fUBF7LIDwiuMj', 'function': {'arguments': '{"query":"Lilian Weng agent memory types"}', 'name': 'retrieve_blog_posts'}, 'type': 'function'}]}, response_metadata={'finish_reason': 'tool_calls', 'model_name': 'gpt-4o-2024-08-06', 'system_fingerprint': 'fp_eb9dce56a8'}, id='run-8ca9485e-ef3a-47a5-b588-3bc2001194e1-0', tool_calls=[{'name': 'retrieve_blog_posts', 'args': {'query': 'Lilian Weng agent memory types'}, 'id': 'call_hoAPuod1TD9fUBF7LIDwiuMj', 'type': 'tool_call'}])]}
'\n---\n'
---é–¢é€£æ€§ãƒã‚§ãƒƒã‚¯---
---åˆ¤æ–­: ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯é–¢é€£ã‚ã‚Š---
"Output from node 'retrieve':"
'---'
{ 'messages': [ ToolMessage(content='The design of generative agents combines LLM with memory, planning and reflection mechanisms to enable agents to behave conditioned on past experience, as well as to interact with other agents.\n\nTable of Contents\n\n\n\nAgent System Overview\n\nComponent One: Planning\n\nTask Decomposition\n\nSelf-Reflection\n\n\nComponent Two: Memory\n\nTypes of Memory\n\nMaximum Inner Product Search (MIPS)\n\n\nComponent Three: Tool Use\n\nCase Studies\n\nScientific Discovery Agent\n\nGenerative Agents Simulation\n\nProof-of-Concept Examples\n\n\nChallenges\n\nCitation\n\nReferences\n\nCitation#\nCited as:\n\nWeng, Lilian. (Jun 2023). â€œLLM-powered Autonomous Agentsâ€. Lilâ€™Log. https://lilianweng.github.io/posts/2023-06-23-agent/.\n\nMemory\n\nShort-term memory: I would consider all the in-context learning (See Prompt Engineering) as utilizing short-term memory of the model to learn.\nLong-term memory: This provides the agent with the capability to retain and recall (infinite) information over extended periods, often by leveraging an external vector store and fast retrieval.\n\n\nTool use', name='retrieve_blog_posts', id='d0560d74-2dbf-4f76-82e7-01049cf68f83', tool_call_id='call_hoAPuod1TD9fUBF7LIDwiuMj')]}
'\n---\n'
---ç”Ÿæˆ---
/usr/local/lib/python3.11/dist-packages/langsmith/client.py:253: LangSmithMissingAPIKeyWarning: API key must be provided when using hosted LangSmith API
  warnings.warn(
"Output from node 'generate':"
'---'
{ 'messages': [ 'Lilian Weng discusses two types of memory in generative '
                'agents: short-term memory and long-term memory. Short-term '
                'memory involves in-context learning, while long-term memory '
                'allows agents to retain and recall information over extended '
                'periods using an external vector store. This dual memory '
                "system enhances the agents' ability to learn from past "
                'experiences and interact effectively.']}
'\n---\n'
```

ç°¡ç•¥åŒ–ã®ãŸã‚ã¨ã“ã‚ã©ã“ã‚çœç•¥ã—ã¦ã„ã‚‹ã®ã§ã€å®Ÿéš›ã«å‹•ã‹ã—ã¦ã¿ãŸã„æ–¹ã¯ã“ã¡ã‚‰ã§ãŠè©¦ã—ãã ã•ã„ï¼
[Google Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯](https://colab.research.google.com/drive/1JOYJrxw8WFBxRMNp_eWwY2PkQHAM4H7t?usp=sharing)

## 4. ã¾ã¨ã‚

ã“ã“ã¾ã§èª­ã‚“ã§ã„ãŸã ãã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼
ä»Šå›ã¯ã€LangGraph ã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ Agentic RAG ã®æ¦‚å¿µã¨å®Ÿè£…æ–¹æ³•ã«ã¤ã„ã¦è¦‹ã¦ã„ãã¾ã—ãŸã€‚è¤‡æ•°ã®æƒ…å ±æºã‹ã‚‰ã®æ¤œç´¢ã‚„æ¤œç´¢çµæœã®æ¤œè¨¼ã‚’è¡Œã†ã“ã¨ãŒã§ãã‚‹ Agentic RAG ã¯ã€ã‚ˆã‚Šé«˜åº¦ãªè³ªå•å¿œç­”ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã™ã‚‹ãŸã‚ã®é‡è¦ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã§ã™ã€‚

è‡ªåˆ†ã‚‚ã“ã®å®Ÿè£…ã‚’å‚è€ƒã«ã‚ˆã‚Šå®Ÿç”¨çš„ãª RAG ã®é–‹ç™ºã‚’ã—ãŸã„ã¨æ€ã„ã¾ã—ãŸã€‚

:::message
ã€ãŠä»•äº‹ã®ã”ä¾é ¼ã€‘
å¼Šç¤¾ã§ã¯ç”Ÿæˆ AI ã‚’ç”¨ã„ãŸã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºã‚’æ”¯æ´ã—ã¦ã„ã¾ã™ã€‚
ã‚‚ã—ãŠä»•äº‹ã®ç›¸è«‡ãŒã‚ã‚Œã°ã“ã¡ã‚‰ãƒ•ã‚©ãƒ¼ãƒ ã‚ˆã‚ŠãŠæ°—è»½ã«ã”ç›¸è«‡ãã ã•ã„ï¼
https://forms.gle/RW1Kpaxwx64RBmgL6

ãƒ¡ãƒ¼ãƒ«ã§ã®å•ã„åˆã‚ã›ã¯ã“ã¡ã‚‰ã‹ã‚‰ã‚ˆã‚ã—ããŠé¡˜ã„ã„ãŸã—ã¾ã™ã€‚
sakai.shun@egghead.co.jp
:::
